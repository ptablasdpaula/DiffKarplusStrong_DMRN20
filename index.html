<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Differentiable Karplus-Strong</title>

  <!-- ======== SOCIAL / SEO ======== -->
  <meta name="description"  content="Differentiable Karplus-Strong – project page with audio examples and code links" />
  <meta property="og:title"        content="Differentiable Karplus-Strong" />
  <meta property="og:description"  content="Audio examples, paper and code for a differentiable, time-domain extended Karplus-Strong algorithm" />
  <meta property="og:url"          content="URL OF THE WEBSITE" />
  <meta property="og:image"        content="DiffKS.jpg" />
  <meta property="og:image:width"  content="1200" />
  <meta property="og:image:height" content="630" />
  <meta name="twitter:title"  content="Differentiable Karplus-Strong" />
  <meta name="twitter:image"  content="DiffKS.jpg" />
  <meta name="twitter:card"   content="summary_large_image" />
  <meta name="keywords"       content="audio synthesis, differentiable DSP, Karplus-Strong, gradient descent, autoencoder, DMRN+20" />

  <!-- fonts & icons (explicitly load 700 & 800 weights to guarantee bold) -->
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;700;800&family=Noto+Sans:wght@400;700;800&family=Castoro&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

  <!-- ======== STYLES ======== -->
  <style>
    body{font-family:'Google Sans','Noto Sans',Arial,sans-serif;line-height:1.6;color:#333;max-width:1200px;margin:0 auto;padding:20px}
    .container{max-width:900px;margin:0 auto;padding:0 20px}
    h1,h2,h3{text-align:center;margin-bottom:1.5rem}
    h1{color:#2c3e50;margin-bottom:2rem}
    h2{color:#34495e;margin-top:3rem;margin-bottom:2rem}
    .abstract{background:#f8f9fa;padding:2rem;border-radius:8px;margin:2rem 0;text-align:justify}

    table{border-collapse:collapse;width:100%;max-width:900px;margin:2rem auto;box-shadow:0 2px 8px rgba(0,0,0,.1);border-radius:8px;overflow:hidden}
    th,td{border:1px solid #e1e5e9;padding:10px;text-align:center}
    th{background:#f0f0f0;font-weight:600}

    #table-sounds-oracle th,
    #table-sounds-oracle td {
      width: 50%;
    }

    .play-btn,.ctrl-btn{cursor:pointer;padding:6px 14px;background:#007BFF;color:#fff;border:none;border-radius:6px;font-size:15px;transition:.3s;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .play-btn:hover,.ctrl-btn:hover{transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,.15)}
    .waveform,.spectrogram{height:80px;background:#e8e8e8;margin:6px 0;border-radius:4px;border:1px solid #ddd}
    .controls{display:flex;justify-content:center;gap:6px;margin-bottom:10px}

    .playerHead{text-align:center;margin-top:3rem}
    .hero{margin:2rem 0}

    .button{display:inline-block;padding:10px 18px;text-decoration:none;border-radius:6px;transition:.3s}
    .is-dark{background:#2c3e50;color:#fff}
    .is-dark:hover{background:#34495e;transform:translateY(-1px)}

    .button.is-dark:disabled,
    .button.is-dark[disabled] {
      background:#9aa3b1;
      cursor:default;
      opacity:0.6;
      box-shadow:none;
    }

    .table-caption{max-width:900px;margin:0.5rem auto 0;text-align:center;font-size:0.9rem}

    .metrics th,.metrics td{font-size:14px}
    .metrics td strong,
    .metrics th strong,
    .metrics td span[style*="font-weight:700"]{font-weight:800 !important;}
    .filter-cell{
      cursor:pointer;
      transition: background-color 0.15s ease;
    }

    /* base pastel colours */
    .val-pos-strong { background-color: rgba(255, 99, 71, 0.22); }
    .val-pos-med    { background-color: rgba(255, 99, 71, 0.16); }
    .val-pos-light  { background-color: rgba(255, 99, 71, 0.10); }
    .val-neg-strong { background-color: rgba(60, 179, 113, 0.22); }
    .val-neg-med    { background-color: rgba(60, 179, 113, 0.16); }
    .val-neg-light  { background-color: rgba(60, 179, 113, 0.10); }

    /* slightly more intense on hover for coloured cells */
    td.val-pos-strong.filter-cell:hover { background-color: rgba(255, 99, 71, 0.30) !important; }
    td.val-pos-med.filter-cell:hover    { background-color: rgba(255, 99, 71, 0.24) !important; }
    td.val-pos-light.filter-cell:hover  { background-color: rgba(255, 99, 71, 0.18) !important; }
    td.val-neg-strong.filter-cell:hover { background-color: rgba(60, 179, 113, 0.30) !important; }
    td.val-neg-med.filter-cell:hover    { background-color: rgba(60, 179, 113, 0.24) !important; }
    td.val-neg-light.filter-cell:hover  { background-color: rgba(60, 179, 113, 0.18) !important; }

    /* labels / mean cells without base colour get a subtle grey hover */
    .filter-cell:hover {
      background-color: rgba(0, 0, 0, 0.10);
    }
  </style>
<script>
  window.MathJax = {
    tex: { inlineMath: [['\\(','\\)'], ['$', '$']] },
    svg: { fontCache: 'global' }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
</head>
<body>
  <!-- ===== HEADER ===== -->
  <section class="hero">
    <div class="hero-body">
      <div class="container is-max-desktop">
        <div class="columns is-centered"><div class="column has-text-centered">
          <h1 class="title is-1">Differentiable Karplus-Strong</h1>
          <div class="is-size-5" style="text-align:center">
            <span><a href="https://github.com/ptablasdpaula/" target="_blank">Pablo Tablas de Paula</a>, </span>
            <span><a href="https://github.com/davidmarttila" target="_blank">David Marttila</a>, </span>
            <span><a href="https://www.eecs.qmul.ac.uk/~josh/" target="_blank">Joshua D. Reiss</a></span><br>
            <span>Centre For Digital Music (C4DM), Queen Mary University Of London</span><br>
            <span>Digital Music Research Network One-day Workshop 2025</span>
          </div>
          <div style="margin-top:1rem; text-align:center">
            <a href="static/paper.pdf" target="_blank" class="button is-dark is-rounded"><i class="fas fa-file-pdf"></i>&nbsp;Paper</a>
            <a href="https://github.com/ptablasdpaula/DiffKarplusStrong_DMRN20" target="_blank" class="button is-dark is-rounded"><i class="fab fa-github"></i>&nbsp;Code</a>
          </div>
        </div></div>
      </div>
    </div>
  </section>

  <!-- ===== ABSTRACT & FIGURE ===== -->
  <section class="section hero is-light"><div class="container is-max-desktop">
    <h2 class="title is-3">Abstract</h2>
    <div class="abstract">
      <p>We present a differentiable, time-domain implementation of an extended Karplus-Strong Algorithm (KSA) that can be optimised end-to-end as a Differentiable DSP (DDSP) paradigm. We show its ability for instrument modelling by reconstructing an acoustic guitar dataset, where our proposed Gradient Descent (GD) baseline outperforms a Genetic Algorithm (GA).</p>
    </div>

    <img src="DiffKS.jpg" alt="Differentiable Karplus-Strong architecture" style="width:100%;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1)">
    <p class="table-caption"><strong>Figure 1:</strong> Proposed architecture, where coloured blocks are optimised by gradient descent. <em>Lagrange</em> is short for Lagrange interpolation, while <em>g</em> stands for gain stages.</p>

    <h2 class="title is-3">Gradient Descent vs. Genetic Algorithm</h2>

    <table>
      <caption class="table-caption"><strong>Table 1:</strong> Baselines Comparison. Lower values, in bold, are better.</caption>
      <thead>
        <tr>
          <th>Baseline</th>
          <th>\(\mathcal{L}_{\mathrm{MSS}}\)</th>
          <th>MFCC</th>
          <th>Encodec</th>
          <th>MS-CLAP</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Gradient Descent</td>
          <td><strong>0.79 &plusmn; 0.11</strong></td>
          <td><strong>2.32 &plusmn; 1.50</strong></td>
          <td><strong>19.89</strong></td>
          <td><strong>111.30</strong></td>
        </tr>
        <tr>
          <td>Genetic Algorithm</td>
          <td>1.43 &plusmn; 0.31</td>
          <td>4.10 &plusmn; 1.75</td>
          <td>216.93</td>
          <td>346.93</td>
        </tr>
      </tbody>
    </table>

    <section class="hero is-small">
      <div class="hero-body">
        <div class="container" id="audio-section">
          <button class="button is-dark" id="shuffle-sounds" style="display:block; margin:0 auto">&#128256; Shuffle Examples</button>
          <table id="table-sounds">
            <thead>
              <tr>
                <th>Ground Truth</th>
                <th>Gradient Descent</th>
                <th>Genetic Algorithm</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>


    <h2 class="title is-3">Model Expressivity Test per Octave and Dynamics</h2>

    <table>
      <caption class="table-caption"><strong>Table 2:</strong> \(\mathcal{L}_{\mathrm{MSS}}\) mean difference to overall mean (0.62) across MIDI velocities and octaves for our GD baseline. Negative values are better.</caption>
      <thead>
        <tr>
          <th><small>\(\downarrow\) Oct. Vel. \(\rightarrow\)</small></th>
          <th class="filter-cell" data-vel="25">25</th>
          <th class="filter-cell" data-vel="50">50</th>
          <th class="filter-cell" data-vel="75">75</th>
          <th class="filter-cell" data-vel="100">100</th>
          <th class="filter-cell" data-vel="127">127</th>
          <th>mean</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="filter-cell" data-oct="E2-E3">E2&ndash;E3</td>
          <td class="val-pos-strong filter-cell" data-oct="E2-E3" data-vel="25">+0.27</td>
          <td class="val-pos-med filter-cell" data-oct="E2-E3" data-vel="50">+0.23</td>
          <td class="val-pos-strong filter-cell" data-oct="E2-E3" data-vel="75">+0.33</td>
          <td class="val-pos-strong filter-cell" data-oct="E2-E3" data-vel="100">+0.30</td>
          <td class="val-pos-strong filter-cell" data-oct="E2-E3" data-vel="127">+0.36</td>
          <td class="val-pos-strong filter-cell" data-oct="E2-E3">+0.30</td>
        </tr>
        <tr>
          <td class="filter-cell" data-oct="E3-E4">E3&ndash;E4</td>
          <td class="val-neg-light filter-cell" data-oct="E3-E4" data-vel="25">-0.02</td>
          <td class="val-pos-light filter-cell" data-oct="E3-E4" data-vel="50">+0.07</td>
          <td class="val-neg-light filter-cell" data-oct="E3-E4" data-vel="75">-0.02</td>
          <td class="val-pos-light filter-cell" data-oct="E3-E4" data-vel="100">+0.07</td>
          <td class="val-pos-light filter-cell" data-oct="E3-E4" data-vel="127">+0.01</td>
          <td class="val-pos-light filter-cell" data-oct="E3-E4">+0.02</td>
        </tr>
        <tr>
          <td class="filter-cell" data-oct="E4-E5">E4&ndash;E5</td>
          <td class="val-neg-med filter-cell" data-oct="E4-E5" data-vel="25">-0.18</td>
          <td class="val-neg-med filter-cell" data-oct="E4-E5" data-vel="50">-0.10</td>
          <td class="val-neg-light filter-cell" data-oct="E4-E5" data-vel="75">-0.05</td>
          <td class="val-neg-med filter-cell" data-oct="E4-E5" data-vel="100">-0.13</td>
          <td class="val-neg-med filter-cell" data-oct="E4-E5" data-vel="127">-0.08</td>
          <td class="val-neg-med filter-cell" data-oct="E4-E5">-0.11</td>
        </tr>
        <tr>
          <td class="filter-cell" data-oct="E5-E6">E5&ndash;E6</td>
          <td class="val-neg-med filter-cell" data-oct="E5-E6" data-vel="25">-0.19</td>
          <td class="val-neg-strong filter-cell" data-oct="E5-E6" data-vel="50">-0.26</td>
          <td class="val-neg-strong filter-cell" data-oct="E5-E6" data-vel="75">-0.27</td>
          <td class="val-neg-med filter-cell" data-oct="E5-E6" data-vel="100">-0.18</td>
          <td class="val-neg-med filter-cell" data-oct="E5-E6" data-vel="127">-0.11</td>
          <td class="val-neg-strong filter-cell" data-oct="E5-E6">-0.20</td>
        </tr>
        <tr>
          <td><strong>mean</strong></td>
          <td class="val-neg-light filter-cell" data-vel="25">-0.03</td>
          <td class="val-neg-light filter-cell" data-vel="50">-0.01</td>
          <td class="filter-cell" data-vel="75">+0.00</td>
          <td class="val-pos-light filter-cell" data-vel="100">+0.02</td>
          <td class="val-pos-light filter-cell" data-vel="127">+0.05</td>
          <td class="filter-cell">+0.00</td>
        </tr>
      </tbody>
    </table>

    <section class="hero is-small">
      <div class="hero-body">
        <div class="container" id="audio-section-oracle">
          <p style="text-align:center; margin:12px 0; font-size:0.95rem; opacity:0.85;">
            Click any cell in the table above to explore audio examples for that specific combination of pitch and dynamics.
          </p>
          <div style="display:flex; justify-content:center; gap:10px; margin-bottom:10px;">
            <button class="button is-dark" id="prev-page-oracle">&laquo; Previous</button>
            <button class="button is-dark" id="next-page-oracle">Next &raquo;</button>
          </div>
          <div id="oracle-page-indicator" style="text-align:center; margin-bottom:8px; font-size:0.9rem; opacity:0.8;">
            Page 1 / 1
          </div>
          <table id="table-sounds-oracle">
            <thead>
              <tr>
                <th>Ground Truth</th>
                <th>Gradient Descent</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

  </div></section>

  <!-- ===== BIBTEX ===== -->
  <section class="section" id="BibTeX"><div class="container is-max-desktop content">
    <h2 class="title">BibTeX</h2>
    <p>If you use this work, please cite:</p>
    <p><em>Tablas de Paula, P., Marttila, D. and Reiss, J.D., 2025 December. Differentiable Karplus-Strong. In Digital music research network one-day workshop (DMRN+20).</em></p>
    <pre><code>@inproceedings{tablas2025diffks,
  title     = {Differentiable Karplus-Strong},
  author    = {Tablas de Paula, Pablo and Marttila, David and Reiss, Joshua D.},
  booktitle = {Digital Music Research Network One-day Workshop (DMRN+20)},
  year      = {2025},
  month     = dec
}</code></pre>
  </div></section>

  <!-- ===== FOOTER ===== -->
  <footer class="footer"><div class="container"><p style="text-align:center;font-size:0.85rem">&copy; 2025 Differentiable Karplus-Strong &mdash; built from the Academic Project Page template.</p></div></footer>

  <!-- ===== PLAYER & TABLE SCRIPT ===== -->
  <script type="module">
  import WaveSurfer from 'https://cdn.jsdelivr.net/npm/wavesurfer.js@7/dist/wavesurfer.esm.js';
  import Spectrogram from 'https://cdn.jsdelivr.net/npm/wavesurfer.js@7/dist/plugins/spectrogram.js';

  /* ---------- BASIC CONFIG ---------- */
  const AUDIO_EXT = '.wav';   // change if your files use another extension
  const ROWS      = 3;        // how many examples to show at once

  const PATH    = 'audio';
  const MODELS  = ['target','gradient','genetic'];
  const LABELS  = { target:'Ground Truth', gradient:'Gradient Descent', genetic:'Genetic Algorithm' };

  /* ---------- HELPERS ---------- */
  async function getIDs() {
    try {
      const r = await fetch(`${PATH}/index.json`, { cache:'no-store' });
      return r.ok ? (await r.json()).samples : [];
    } catch {
      return [];
    }
  }

  const rand = (arr, n) => arr.slice().sort(() => 0.5 - Math.random()).slice(0, Math.min(n, arr.length));
  const icon = (btn, on) => { btn.innerHTML = on ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>'; };

  async function filterValid(ids) {
    const checks = ids.map(async id => {
      for (const m of MODELS) {
        const url  = `${PATH}/${m}/${id}${AUDIO_EXT}`;
        const resp = await fetch(url, { method:'HEAD' });
        if (!resp.ok) return null;           // if any model missing → drop this id
      }
      return id;
    });
    return (await Promise.all(checks)).filter(Boolean);
  }

  /* ---------- PLAYER CACHE ---------- */
  const players = new Map();

  function makePlayer(td, url) {
    const wf = td.querySelector('.waveform');
    const sp = td.querySelector('.spectrogram');
    const ws = WaveSurfer.create({
      container: wf,
      backend: 'MediaElement',
      height: 80,
      waveColor: '#999',
      progressColor: '#007BFF',
      plugins: [
        Spectrogram.create({ container: sp, scale: 'mel', labels: false, height: 80 })
      ]
    });
    ws.load(url);
    return ws;
  }

  function renderRows(ids) {
    const tbody = document.querySelector('#table-sounds tbody');
    tbody.innerHTML = '';

    // destroy old players
    players.forEach(ws => ws.destroy());
    players.clear();

    ids.forEach(id => {
      const row = document.createElement('tr');
      row.dataset.sample = id;

      MODELS.forEach(m => {
        const td = document.createElement('td');
        td.innerHTML = `
          <div class="controls">
            <button class="play-btn"><i class="fas fa-play"></i></button>
            <button class="ctrl-btn" data-act="stop"><i class="fas fa-stop"></i></button>
            <button class="ctrl-btn" data-act="rew"><i class="fas fa-backward"></i></button>
          </div>
          <div class="waveform"></div>
          <div class="spectrogram"></div>`;

        const url  = `${PATH}/${m}/${id}${AUDIO_EXT}`;
        const ws   = makePlayer(td, url);
        const play = td.querySelector('.play-btn');
        const stop = td.querySelector('[data-act="stop"]');
        const rew  = td.querySelector('[data-act="rew"]');

        play.onclick = () => {
          // pause all others
          players.forEach((other, btn) => {
            if (other.isPlaying()) { other.pause(); icon(btn, false); }
          });
          if (ws.isPlaying()) { ws.pause(); icon(play, false); }
          else               { ws.play();  icon(play, true);  }
        };

        stop.onclick = () => { ws.pause(); ws.seekTo(0); icon(play, false); };
        rew.onclick  = () => { ws.seekTo(0); ws.play();  icon(play, true);  };

        players.set(play, ws);
        row.appendChild(td);
      });

      tbody.appendChild(row);
    });
  }
  window.renderRows = renderRows;

  /* ---------- PAGE INITIALISATION ---------- */
  (async () => {
    const shuffleBtn = document.getElementById('shuffle-sounds');

    let pool = await filterValid(await getIDs());
    let visible = rand(pool, ROWS);
    renderRows(visible);

    shuffleBtn.onclick = () => {
      visible = rand(pool, ROWS);
      renderRows(visible);
    };
  })();
  </script>

  <script type="module">
  import WaveSurfer from 'https://cdn.jsdelivr.net/npm/wavesurfer.js@7/dist/wavesurfer.esm.js';
  import Spectrogram from 'https://cdn.jsdelivr.net/npm/wavesurfer.js@7/dist/plugins/spectrogram.js';

  /* ---------- BASIC CONFIG ---------- */
  const AUDIO_EXT_ORACLE = '.wav';   // change if your files use another extension
  const ROWS_ORACLE      = 3;        // how many examples to show at once

  const PATH_ORACLE    = 'audio';
  const MODELS_ORACLE  = ['target','gradient_oracle_f0'];
  const LABELS_ORACLE  = { target:'Ground Truth', gradient_oracle_f0:'Gradient Descent' };

  let poolOracle = [];
  let currentOracleList = [];
  let currentOraclePage = 0;

  /* ---------- HELPERS ---------- */
  async function getIDsOracle() {
    try {
      const r = await fetch(`${PATH_ORACLE}/index.json`, { cache:'no-store' });
      return r.ok ? (await r.json()).samples : [];
    } catch {
      return [];
    }
  }

  const randOracle = (arr, n) => arr.slice().sort(() => 0.5 - Math.random()).slice(0, Math.min(n, arr.length));
  const iconOracle = (btn, on) => { btn.innerHTML = on ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>'; };

  async function filterValidOracle(ids) {
    const checks = ids.map(async id => {
      for (const m of MODELS_ORACLE) {
        const url  = `${PATH_ORACLE}/${m}/${id}${AUDIO_EXT_ORACLE}`;
        const resp = await fetch(url, { method:'HEAD' });
        if (!resp.ok) return null;           // if any model missing → drop this id
      }
      return id;
    });
    return (await Promise.all(checks)).filter(Boolean);
  }

  /* ---------- PLAYER CACHE ---------- */
  const playersOracle = new Map();

  function makePlayerOracle(td, url) {
    const wf = td.querySelector('.waveform');
    const sp = td.querySelector('.spectrogram');
    const ws = WaveSurfer.create({
      container: wf,
      backend: 'MediaElement',
      height: 80,
      waveColor: '#999',
      progressColor: '#007BFF',
      plugins: [
        Spectrogram.create({ container: sp, scale: 'mel', labels: false, height: 80 })
      ]
    });
    ws.load(url);
    return ws;
  }

  function renderRowsOracle(ids) {
    const tbody = document.querySelector('#table-sounds-oracle tbody');
    tbody.innerHTML = '';

    // destroy old players
    playersOracle.forEach(ws => ws.destroy());
    playersOracle.clear();

    ids.forEach(id => {
      const row = document.createElement('tr');
      row.dataset.sample = id;

      MODELS_ORACLE.forEach(m => {
        const td = document.createElement('td');
        td.innerHTML = `
          <div class="controls">
            <button class="play-btn"><i class="fas fa-play"></i></button>
            <button class="ctrl-btn" data-act="stop"><i class="fas fa-stop"></i></button>
            <button class="ctrl-btn" data-act="rew"><i class="fas fa-backward"></i></button>
          </div>
          <div class="waveform"></div>
          <div class="spectrogram"></div>`;

        const url  = `${PATH_ORACLE}/${m}/${id}${AUDIO_EXT_ORACLE}`;
        const ws   = makePlayerOracle(td, url);
        const play = td.querySelector('.play-btn');
        const stop = td.querySelector('[data-act="stop"]');
        const rew  = td.querySelector('[data-act="rew"]');

        play.onclick = () => {
          // pause all others
          playersOracle.forEach((other, btn) => {
            if (other.isPlaying()) { other.pause(); iconOracle(btn, false); }
          });
          if (ws.isPlaying()) { ws.pause(); iconOracle(play, false); }
          else               { ws.play();  iconOracle(play, true);  }
        };

        stop.onclick = () => { ws.pause(); ws.seekTo(0); iconOracle(play, false); };
        rew.onclick  = () => { ws.seekTo(0); ws.play();  iconOracle(play, true);  };

        playersOracle.set(play, ws);
        row.appendChild(td);
      });

      tbody.appendChild(row);
    });
  }
  window.renderRowsOracle = renderRowsOracle;

  function renderPageOracle() {
    const start = currentOraclePage * ROWS_ORACLE;
    const pageIds = currentOracleList.slice(start, start + ROWS_ORACLE);
    renderRowsOracle(pageIds);
  }

  window.renderPageOracle = renderPageOracle;

  function applyOracleFilter(octLabel, velMidi) {
    if (!Array.isArray(poolOracle) || poolOracle.length === 0) return;

    const OCT_MAP = {
      'E2-E3': 'oct1_',
      'E3-E4': 'oct2_',
      'E4-E5': 'oct3_',
      'E5-E6': 'oct4_'
    };

    const VEL_MAP = {
      '25':  'velp',
      '50':  'velmp',
      '75':  'velmf',
      '100': 'velf',
      '127': 'velff'
    };

    let filtered = poolOracle.slice();

    if (octLabel && OCT_MAP[octLabel]) {
      const octPrefix = OCT_MAP[octLabel];
      filtered = filtered.filter(id => id.startsWith(octPrefix));
    }

    if (velMidi && VEL_MAP[velMidi]) {
      const velTag = VEL_MAP[velMidi];
      filtered = filtered.filter(id => id.includes(`_${velTag}_`));
    }

    currentOracleList = filtered;
    currentOraclePage = 0;
    renderPageOracle();
    updateOracleButtons();
  }

  window.applyOracleFilter = applyOracleFilter;

  /* ---------- PAGE INITIALISATION ---------- */
  (async () => {
    const prevBtnOracle = document.getElementById('prev-page-oracle');
    const nextBtnOracle = document.getElementById('next-page-oracle');
    const pageIndicatorOracle = document.getElementById('oracle-page-indicator');

    function updateOracleButtons() {
      const total = currentOracleList.length;
      const maxPage = total === 0 ? 0 : Math.floor((total - 1) / ROWS_ORACLE);

      if (prevBtnOracle) {
        prevBtnOracle.disabled = currentOraclePage <= 0;
      }
      if (nextBtnOracle) {
        nextBtnOracle.disabled = currentOraclePage >= maxPage;
      }

      if (pageIndicatorOracle) {
        const totalPages = total === 0 ? 0 : (maxPage + 1);
        const currentPage = total === 0 ? 0 : (currentOraclePage + 1);
        pageIndicatorOracle.textContent = `Page ${currentPage} / ${totalPages || 1}`;
      }
    }

    window.updateOracleButtons = updateOracleButtons;

    poolOracle = await filterValidOracle(await getIDsOracle());
    currentOracleList = poolOracle.slice();
    currentOraclePage = 0;
    renderPageOracle();
    updateOracleButtons();

    if (prevBtnOracle) {
      prevBtnOracle.addEventListener('click', () => {
        if (currentOraclePage > 0) {
          currentOraclePage--;
          renderPageOracle();
          updateOracleButtons();
        }
      });
    }

    if (nextBtnOracle) {
      nextBtnOracle.addEventListener('click', () => {
        const total = currentOracleList.length;
        const maxPage = total === 0 ? 0 : Math.floor((total - 1) / ROWS_ORACLE);
        if (currentOraclePage < maxPage) {
          currentOraclePage++;
          renderPageOracle();
          updateOracleButtons();
        }
      });
    }
  })();
  </script>
</body>
<script>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.filter-cell').forEach(cell => {
    cell.addEventListener('click', () => {
      const octLabel = cell.dataset.oct || null;
      const velMidi  = cell.dataset.vel || null;
      if (window.applyOracleFilter) {
        window.applyOracleFilter(octLabel, velMidi);
      }
    });
  });
});
</script>
</html>